name: Build wheels

on:
  workflow_dispatch:
  release:
    types:
      - published

jobs:
  build_wheels:
    name: Wheels â€¢ ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        # Supported macOS-10.x
        - os: macos-10.15
          build: "cp36-macosx_x86_64 cp39-macosx_x86_64"
          name: macOS (10.15+)

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: ${{ matrix.arch }}

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.9

      - name: Build wheels
        uses: pypa/cibuildwheel@main
        env:
          CIBW_BUILD: ${{ matrix.build }}
          CIBW_ARCHS: x86_64
          CIBW_TEST_REQUIRES: pytest
          CIBW_TEST_COMMAND: pytest --import-mode importlib -v {project}/python/test/
          CMAKE_BUILD_PARALLEL_LEVEL: 2
          MACOSX_DEPLOYMENT_TARGET: '10.11'

      - name: Upload built wheels
        uses: actions/upload-artifact@v2
        with:
          name: wheels
          path: ./wheelhouse/*.whl
